library(slingshot) 
library(Seurat)
library(devtools)
library(Seurat)
library(cowplot)
library(ggplot2)
library(Matrix)
library(dplyr)
library(tradeSeq)
library(RColorBrewer)

cd8$celltype=NULL
cd8$celltype=Idents(cd8)

table(cd8$celltype)
sce <- as.SingleCellExperiment(cd8, assay = "RNA")
sce_slingshot1 <- slingshot(sce, 
                            reducedDim = 'UMAP', 
                            clusterLabels = sce$celltype, 
                            #start.clus = 'PMN(0)', 
                            approx_points = 150)

expdata <- as.matrix(GetAssayData(object = cd8, slot = "data"))
sce <- SingleCellExperiment(assays = List(counts = expdata))
reduction_sce <- Embeddings(object = cd8, reduction = "umap")
reducedDims(sce) <- SimpleList(UMAP = reduction_sce)
colData(sce)$celltype <- cd8@meta.data$celltype
colData(sce)$orig.ident <- cd8@meta.data$orig.ident 

sce_slingshot2 <- slingshot(sce, 
                            clusterLabels = 'celltype', 
                            reducedDim = 'UMAP', 
                            start.clus = 'CD8_TCF7', 
                            end.clus=c("CD8_PDCD1"),
                            approx_points = 150)
SlingshotDataSet(sce_slingshot2) 



sudo apt-get install libgdal-dev
sudo apt install libudunits2-dev

BiocManager::install(c('BiocGenerics', 'DelayedArray', 'DelayedMatrixStats',
                       'limma', 'lme4', 'S4Vectors', 'SingleCellExperiment',
                       'SummarizedExperiment', 'batchelor', 'Matrix.utils',
                       'HDF5Array', 'terra', 'ggrastr'))

remotes::install_github("rspatial/terra") 
install.packages("devtools")
devtools::install_github('cole-trapnell-lab/monocle3')
library(monocle3)
library(Seurat)
library(ggplot2)
library(dplyr)

expression_matrix <- as(as.matrix(cd8@assays$RNA@counts), 'sparseMatrix')
table(Idents(cd8))
cd8$celltype=Idents(cd8)
cell_metadata <- cd8@meta.data
gene_annotation <- data.frame(gene_short_name = rownames(expression_matrix))
rownames(gene_annotation) <- rownames(expression_matrix)

cds <- new_cell_data_set(expression_matrix,
                         cell_metadata = cell_metadata,
                         gene_metadata = gene_annotation)

cds <- preprocess_cds(cds, num_dim = 100)#method默认为PCA
plot_pc_variance_explained(cds)#展示PC数，和seurat降维一摸一样

cds <- reduce_dimension(cds,reduction_method='UMAP',
                        preprocess_method = 'PCA')
plot_cells(cds, color_cells_by="celltype",cell_size=0.5,group_label_size=5)
plot_cells(cds, genes=c("PDCD1", "CTLA4", "SIK3", "SMYD3"))

cds<-cluster_cells(cds, resolution =0.00005)  
plot_cells(cds,cell_size=0.5,group_label_size=5)
cds.embed <- cds@int_colData$reducedDims$UMAP
int.embed <- Embeddings(cd8, reduction = "umap")
int.embed <- int.embed[rownames(cds.embed),]
cds@int_colData$reducedDims$UMAP <- int.embed 

plot_cells(cds, color_cells_by="celltype",
           cell_size=0.5,group_label_size=4) 

mycds <- cds
mycds <- learn_graph(mycds,
                     verbose=T,
                     learn_graph_control=list(minimal_branch_len=10,
                                             
                                              euclidean_distance_ratio=0
                                              
                     ))



plot_cells(mycds, 
           color_cells_by = 'celltype',
           label_groups_by_cluster=FALSE,
           label_leaves=FALSE,
           label_branch_points=FALSE,
           cell_size=0.5,group_label_size=4)


plot_cells(mycds, 
           color_cells_by = "celltype", 
           label_groups_by_cluster=FALSE,
           label_leaves=TRUE, 
           label_branch_points=TRUE,
           graph_label_size=4)



mycds1 <- mycds
mycds1 <- order_cells(mycds1)
plot_cells(mycds1, label_cell_groups = F,
           color_cells_by = "pseudotime", 
           label_leaves = F, 
           label_branch_points = F, 
           graph_label_size = 1, 
           cell_size=0.15,  
           trajectory_graph_segment_size = 2)

mycds2 <- mycds
mycds2 <- order_cells(mycds2)

plot_cells(mycds2, label_cell_groups = F,
           color_cells_by = "pseudotime", 
           label_leaves = F, 
           label_branch_points = F, 
           graph_label_size = 1, 
           cell_size=0.15,  
           trajectory_graph_segment_size = 2)




BiocManager::install("sva") 

devtools::install_local("CytcellRACE_0.3.3.tar.gz") 

sudo apt-get install libnetcdf-dev
install.packages('ncdf4') 
library(CytcellRACE)
install.packages("reticulate")
library(reticulate)
exp1 <- as.matrix(cd8@assays$RNA@counts)
exp1 <- exp1[apply(exp1 > 0,1,sum) >= 5,]
results <- CytcellRACE(exp1,ncores = 20) 

cd8$celltype=NULL
cd8$celltype=Idents(cd8)
phenot <- cd8$celltype
phenot <- as.character(phenot)
names(phenot) <- rownames(cd8@meta.data)
emb <- cd8@reductions[["umap"]]@cell.embeddings

plotCytcellRACE(results, phenotype = phenot, emb = emb, outputDir = './')
plotCytoGenes(results, numOfGenes = 30, outputDir = './')
plotCytcellRACE(results, phenotype = phenot,emb = emb,gene = "SIK3",outputDir = "./")



addArchRThreads(threads = 10)
tcell <- addGroupCoverages(ArchRProj = tcell, groupBy = "celltype",force=TRUE) #48分钟

pathToMacs2 <-"/home/ccell/miniconda3/envs/macs/bin/macs2"
tcell <- addReproduciblePeakSet(
  ArchRProj = tcell, 
  groupBy = "celltype",pathToMacs2 = pathToMacs2,force=TRUE
)
getPeakSet(tcell)


tcell <- addPeakMatrix(tcell)
getAvailableMatrices(tcell)


tcell <- addPeak2GeneLinks(
  ArchRProj = tcell,
  reducedDims = "IterativeLSI"
)

p2g <- getPeak2GeneLinks(
  ArchRProj = tcell,
  corCutOff = 0.45,
  resolution = 1,
  returnLoops = T
)

metadata(p2g)
p2g[[1]]



markerGenes  <- c(
  "TGFB1"
)

p <- plotBrowserTrack(
  ArchRProj = tcell, 
  groupBy = "celltype", 
  geneSymbol = markerGenes, 
  upstream = 50000,
  downstream = 50000,
  loops = getPeak2GeneLinks(tcell)
)

grid::grid.newpage()
grid::grid.draw(p$TGFB1)




addArchRThreads(threads = 15)
library(BSgenome.Hsapiens.UCSC.hg38)
tcell <- addGroupCoverages(ArchRProj = tcell, groupBy = "celltype",force = TRUE)

pathToMacs2 <-"/home/ccell/miniconda3/envs/macs/bin/macs2"
tcell <- addReproduciblePeakSet(
  ArchRProj = tcell, 
  groupBy = "celltype",pathToMacs2 = pathToMacs2,force = TRUE
)

getPeakSet(tcell)
tcell <- addPeakMatrix(tcell)
getAvailableMatrices(tcell)

table(tcell$celltype)
markersPeaks <- getMarkerFeatures(
  ArchRProj = tcell, 
  useMatrix = "PeakMatrix", 
  groupBy = "celltype",
  bias = c("TSSEnrichment", "log10(nFrags)"),
  testMethod = "wilcoxon"
)

markerTest <- getMarkerFeatures(
  ArchRProj = tcell, 
  useMatrix = "PeakMatrix",
  groupBy = "celltype",
  testMethod = "wilcoxon",
  bias = c("TSSEnrichment", "log10(nFrags)")
)

tcell <- addMotifAnnotations(ArchRProj = tcell, motifSet = "cisbp", name = "Motif",force=TRUE)

motifsUp <- peakAnnoEnrichment(
  seMarker = markerTest,
  ArchRProj = tcell,
  peakAnnotation = "Motif",
  cutOff = "FDR <= 0.05 & Log2FC >= 0.5"
)
motifsUp

df <- data.frame(TF = rownames(motifsUp), mlog10Padj = assay(motifsUp)[,1])

assay(motifsUp)

df <- data.frame(TF = rownames(motifsUp), mlog10Padj = assay(motifsUp)[,1])
df <- df[order(df$mlog10Padj, decreasing = TRUE),]
df$rank <- seq_len(nrow(df))

df <- read.delim(file = "/home/ccell/ggup-tcell.txt", header = TRUE, row.names = 1)
df <- df[rownames(df) != "103", , drop = FALSE]


df <- df[1:100, c("rank","TF", "mlog10Padj"), drop = FALSE] 

ggUp <- ggplot(df, aes(rank, mlog10Padj, color = mlog10Padj)) + 
  geom_point(size = 1) +
  ggrepel::geom_label_repel(
    data = df[rev(seq_len(5)), ], aes(x = rank, y = mlog10Padj, label = TF), 
    size = 1.5,
    nudge_x = 2,
    color = "black"
  ) + theme_ArchR() + 
  ylab("-log10(P-adj) Motif Enrichment") + 
  xlab("Rank Sorted TFs Enriched") +
  scale_color_gradientn(colors = paletteContinuous(set = "comet"))

ggUp



data <- as.matrix(data)

samples <- rep(c("g1","g2","g3","g4"), c(2,2,2,2)) 
for (i in 1:nrow(data)) 
  data[i, ] <- scale(log(unlist(data[i, ] + 1), 2))
Group = factor(rep(c("g1","g2","g3","g4"),times = c(2,2,2,2)))

Group = factor(Group,levels = c("g1","g2","g3","g4"))

library(ComplexHeatmap)
top_annotation = HeatmapAnnotation(cluster = anno_block(gp = gpar(fill = c("#009933", "#FF3333","orange","blue")),
                                                        labels = c("g1","g2","g3","g4"),
                                                        labels_gp = gpar(col = "black", fontsize = 12)))


genes <- c("ITGAE", "IL2RA", "HAVCR2", "TIGIT", "LAYN", "TOX",
           
           "TOX2", "GNLY", "IFNG",  "TBX21", "GZMA",
           
           "CD74", "SIK3", "SMYD3", "ZBTB20", "ARL15", "ASH1L",
           
           "TGFB1"
)


index=which(rownames(data) %in% genes)
labs=rownames(data)[index]
lab2=rowAnnotation(foo=anno_mark(at=index,
                                 labels=labs,
                                 labels_gp = gpar(fontsize = 5),
                                 lines_gp = gpar()
))

library(Cairo)
Heatmap( data,
         col = colorRampPalette(c("#2fa1dd", "white", "red"))(100),
         show_row_names = F,
         top_annotation = top_annotation,
         right_annotation = lab2,
         column_split = Group,
         column_title = NULL,
         show_column_names = T,
         cluster_columns = F, cluster_rows = FALSE,
         show_row_dend = FALSE,
         use_raster=F,
         border = 'black',
         rect_gp = gpar(col = "black", lwd = 1))
